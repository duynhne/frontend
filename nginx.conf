server {
    listen 80;
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    # Health check endpoint for k8s probes
    location = /health {
        add_header Content-Type text/plain;
        return 200 'ok';
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # IMPORTANT (Kubernetes DNS):
    # Nginx resolves literal upstream hostnames at startup, which can fail transiently (race with DNS/network).
    # Use `resolver` + variable-based `proxy_pass` to defer DNS resolution to request time.
    # kube-dns service IP in this cluster: 10.96.0.10
    resolver 10.96.0.10 ipv6=off valid=10s;
    resolver_timeout 5s;
    
    # API Gateway - Proxy to microservices
    # Product Service
    location /api/v1/products {
        set $upstream_product product.product.svc.cluster.local:8080;
        proxy_pass http://$upstream_product;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cart Service
    location /api/v1/cart {
        set $upstream_cart cart.cart.svc.cluster.local:8080;
        proxy_pass http://$upstream_cart;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Order Service
    location /api/v1/orders {
        set $upstream_order order.order.svc.cluster.local:8080;
        proxy_pass http://$upstream_order;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Auth Service
    location /api/v1/auth {
        set $upstream_auth auth.auth.svc.cluster.local:8080;
        proxy_pass http://$upstream_auth;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # User Service
    location /api/v1/users {
        set $upstream_user user.user.svc.cluster.local:8080;
        proxy_pass http://$upstream_user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Review Service
    location /api/v1/reviews {
        set $upstream_review review.review.svc.cluster.local:8080;
        proxy_pass http://$upstream_review;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Notification Service
    location /api/v1/notifications {
        set $upstream_notification notification.notification.svc.cluster.local:8080;
        proxy_pass http://$upstream_notification;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Shipping Service
    location /api/v1/shipping {
        set $upstream_shipping shipping.shipping.svc.cluster.local:8080;
        proxy_pass http://$upstream_shipping;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Note: v2 APIs removed - v1 is the canonical API (frontend-aligned)

    # Serve static files with caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA routing - fallback to index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }
}
