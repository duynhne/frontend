import{c as P,e as _,k as $,r as i,g as E,j as e,L as C,l as I}from"./index-y3nl-1dH.js";import{c as R}from"./orderApi-CMmRn4zE.js";import{t as m}from"./errorMessages-JRjuVPVt.js";function D(){var y,f,b,N,S,k;const d=P(),{notify:l}=_(),{mutate:O}=$(),[s,v]=i.useState(null),[n,j]=i.useState(!0),[o,h]=i.useState(null),[p,g]=i.useState(!1),[a,T]=i.useState(null),u=i.useCallback(async()=>{j(!0),h(null);try{const t=await E();v(t)}catch(t){const r=m(t==null?void 0:t.message);h(r),l("error",r)}finally{j(!1)}},[l]);i.useEffect(()=>{if(!localStorage.getItem("authToken")){d("/login?returnTo=/checkout");return}u()},[d,u]);const w=async t=>{t.preventDefault(),g(!0),h(null);try{const r={items:s.items.map(c=>({product_id:c.product_id,product_name:c.product_name,quantity:c.quantity,price:c.product_price}))},x=await R(r);T(x),l("success","Order created successfully!");try{await I(),await O("cart-count")}catch(c){const F=m(c==null?void 0:c.message);l("error",`Order created, but failed to clear cart: ${F}`)}}catch(r){const x=m(r==null?void 0:r.message);l("error",x)}finally{g(!1)}};return e.jsxs("div",{className:"page container",children:[e.jsx(C,{to:"/cart",className:"back-link",children:"← Back to Cart"}),e.jsx("h2",{children:"Checkout"}),e.jsx("p",{className:"api-label",children:"API: POST /api/v1/orders"}),n&&e.jsx("div",{className:"loading",children:"Loading..."}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"success",children:[e.jsx("h3",{children:"✅ Order Created Successfully!"}),e.jsxs("p",{children:["Order ID: ",a.id]}),e.jsxs("p",{children:["Status: ",a.status]}),e.jsxs("p",{children:["Total: $",(y=a.total)==null?void 0:y.toFixed(2)]})]}),e.jsx("button",{onClick:()=>d("/orders"),style:{marginTop:"0.75rem"},children:"View Orders"}),e.jsxs("details",{className:"api-debug",children:[e.jsx("summary",{children:"API Response"}),e.jsx("pre",{children:JSON.stringify(a,null,2)})]})]}),!n&&!a&&!o&&(!s||!s.items||s.items.length===0)&&e.jsxs("div",{className:"empty",children:[e.jsx("p",{children:"Cart is empty. Add items first."}),e.jsx(C,{to:"/",children:"Browse Products"})]}),!n&&!a&&o&&!((f=s==null?void 0:s.items)!=null&&f.length)&&e.jsxs("div",{className:"error-box",children:[e.jsx("strong",{children:"Error:"})," ",o,e.jsx("button",{type:"button",className:"primary",style:{marginTop:"0.75rem"},onClick:u,children:"Try Again"})]}),!n&&!a&&((b=s==null?void 0:s.items)==null?void 0:b.length)>0&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"two-col",children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Order Items"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{className:"hide-mobile",children:"Price"}),e.jsx("th",{children:"Subtotal"})]})}),e.jsx("tbody",{children:s.items.map(t=>{var r;return e.jsxs("tr",{children:[e.jsx("td",{children:t.product_name}),e.jsx("td",{children:t.quantity}),e.jsxs("td",{className:"hide-mobile",children:["$",t.product_price]}),e.jsxs("td",{children:["$",(r=t.subtotal)==null?void 0:r.toFixed(2)]})]},t.id)})})]})})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Order Summary"}),e.jsx("table",{children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("th",{children:"Subtotal"}),e.jsxs("td",{children:["$",(N=s.subtotal)==null?void 0:N.toFixed(2)]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:"Shipping"}),e.jsxs("td",{children:["$",(S=s.shipping)==null?void 0:S.toFixed(2)]})]}),e.jsxs("tr",{children:[e.jsx("th",{children:e.jsx("strong",{children:"Total"})}),e.jsx("td",{children:e.jsxs("strong",{children:["$",(k=s.total)==null?void 0:k.toFixed(2)]})})]})]})}),e.jsx("button",{className:"primary",style:{width:"100%",marginTop:"0.75rem"},onClick:w,disabled:p,children:p?"Creating Order...":"Place Order"})]})]})})]})}export{D as default};
