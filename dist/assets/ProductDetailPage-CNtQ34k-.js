import{j as e,a as M,b as _,c as B,d as G,e as O,r,L as Q,D as z,f as J}from"./index-B_7VeGgU.js";import{P as V,a as I}from"./productApi-DoSkOfiM.js";import{E as P}from"./EmptyState-CHFLAYQf.js";import{A as Y}from"./ApiError-bnzA-mkx.js";import"./errorMessages-JRjuVPVt.js";function q({quantity:t,onChange:l,min:n=1}){const o=()=>l(t+1),a=()=>l(Math.max(n,t-1)),p=m=>{const v=parseInt(m.target.value)||n;l(Math.max(n,v))};return e.jsxs("div",{className:"quantity-selector",children:[e.jsx("label",{children:"Quantity:"}),e.jsx("button",{onClick:a,disabled:t<=n,children:"âˆ’"}),e.jsx("input",{type:"number",value:t,onChange:p,min:n}),e.jsx("button",{onClick:o,children:"+"})]})}async function W(t,l,n,o,a){return(await M.post("/reviews",{product_id:t,user_id:l,rating:n,title:o,comment:a})).data}function H(t){const l=t.created_at||t.createdAt;if(!l)return"â€”";const n=new Date(l);return isNaN(n.getTime())?"â€”":n.toLocaleDateString()}function K(t){return t.username||t.user_name||"Guest"}function ae(){var D;const{id:t}=_(),l=B(),n=G(),{notify:o}=O(),[a,p]=r.useState(null),[m,v]=r.useState(!0),[x,w]=r.useState(null),[d,y]=r.useState([]),[g,b]=r.useState(1),[N,S]=r.useState(!1),[f,E]=r.useState(!1),[c,k]=r.useState(null);r.useEffect(()=>{const s=localStorage.getItem("authToken");E(!!s);try{const i=localStorage.getItem("authUser");k(i?JSON.parse(i):null)}catch{k(null)}},[]);const[u,j]=r.useState({rating:5,title:"",comment:""}),[R,A]=r.useState(!1);r.useEffect(()=>{async function s(){v(!0),w(null);try{const i=await I(t);p(i),y(i.reviews&&Array.isArray(i.reviews)?i.reviews:[])}catch(i){w(i.message)}finally{v(!1)}}s()},[t]);const F=r.useMemo(()=>f&&(c==null?void 0:c.id)&&d.some(s=>String(s.user_id)===String(c.id)),[f,c==null?void 0:c.id,d]);r.useEffect(()=>{if(n.hash==="#reviews"&&!m){const s=document.getElementById("reviews");s&&s.scrollIntoView({behavior:"smooth"})}},[n.hash,m]);const C=async()=>{try{const s=await I(t);y(s.reviews&&Array.isArray(s.reviews)?s.reviews:[])}catch{}},L=async s=>{var i;if(s.preventDefault(),!(c!=null&&c.id)){o("error","User not found. Please log in again.");return}A(!0);try{const h=await W(t,c.id,u.rating,u.title,u.comment);o("success","Review submitted!"),j({rating:5,title:"",comment:""}),await C()}catch(h){((i=h.response)==null?void 0:i.status)===409||h.message&&h.message.toLowerCase().includes("already exists")?(o("info","You have already reviewed this product."),await C()):o("error",h.message||"Failed to submit review")}finally{A(!1)}},$=async()=>{S(!0);try{const s=await J(t,a.product.name,a.product.price,g);o("success",`Added ${g} item${g>1?"s":""} to cart`),b(1)}catch(s){o("error",s.message||"Failed to add to cart")}finally{S(!1)}},T=r.useMemo(()=>d.length>0?(d.reduce((s,i)=>s+i.rating,0)/d.length).toFixed(1):0,[d]);return e.jsxs("div",{className:"page container",children:[e.jsx(Q,{to:"/",className:"back-link",children:"â† Back to Products"}),e.jsxs("p",{className:"api-label",children:["API: GET /api/v1/products/",t,"/details"]}),m&&e.jsx(z,{}),!m&&x&&e.jsx(Y,{error:x,endpoint:`GET /api/v1/products/${t}/details`}),!m&&!x&&!(a!=null&&a.product)&&e.jsx(P,{message:"Product not found",icon:"ðŸ”"}),!m&&!x&&(a==null?void 0:a.product)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"detail-layout",children:[e.jsx("div",{className:"detail-image",children:e.jsx(V,{size:"large",label:"Product Image"})}),e.jsxs("div",{className:"detail-info",children:[e.jsx("h1",{children:a.product.name}),e.jsx("p",{className:"detail-description",children:a.product.description}),e.jsxs("p",{className:"detail-price",children:["$",a.product.price]}),a.stock&&e.jsx("p",{className:a.stock.available?"stock-available":"stock-out",children:a.stock.available?`In Stock (${a.stock.quantity})`:"Out of Stock"}),e.jsx(q,{quantity:g,onChange:b,min:1}),e.jsx("button",{className:"btn-primary add-to-cart-btn",onClick:$,disabled:N||!((D=a.stock)!=null&&D.available),children:N?"Adding...":"Add to Cart"})]})]}),e.jsxs("div",{id:"reviews",className:"reviews-section",children:[e.jsx("h2",{children:"Customer Reviews"}),d.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"reviews-summary",children:[e.jsx("span",{className:"reviews-score",children:T}),e.jsx("span",{className:"reviews-stars",children:"â­".repeat(Math.round(T))}),e.jsxs("span",{className:"text-muted",children:["(",d.length," reviews)"]})]}),e.jsx("div",{className:"reviews-list",children:d.map(s=>e.jsxs("div",{className:"review-item",children:[e.jsxs("div",{className:"review-header",children:[e.jsx("span",{className:"review-stars",children:"â­".repeat(s.rating)}),e.jsx("span",{className:"text-muted",children:H(s)})]}),s.title&&e.jsx("h4",{children:s.title}),e.jsx("p",{children:s.comment}),e.jsxs("p",{className:"text-muted",children:["By ",K(s)]})]},s.id))})]}):e.jsx(P,{message:"No reviews yet",icon:"ðŸ“"}),e.jsxs("div",{className:"write-review",style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid var(--border)"},children:[e.jsx("h3",{children:"Write a Review"}),f?F?e.jsx("div",{className:"empty",style:{padding:"1rem"},children:e.jsx("p",{children:"You have already reviewed this product."})}):e.jsxs("form",{onSubmit:L,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Rating"}),e.jsxs("select",{value:u.rating,onChange:s=>j({...u,rating:parseInt(s.target.value)}),style:{width:"auto"},children:[e.jsx("option",{value:5,children:"â­â­â­â­â­ (5)"}),e.jsx("option",{value:4,children:"â­â­â­â­ (4)"}),e.jsx("option",{value:3,children:"â­â­â­ (3)"}),e.jsx("option",{value:2,children:"â­â­ (2)"}),e.jsx("option",{value:1,children:"â­ (1)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Title (optional)"}),e.jsx("input",{type:"text",placeholder:"Summary of your review",value:u.title,onChange:s=>j({...u,title:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Comment"}),e.jsx("textarea",{placeholder:"Share your thoughts about this product...",value:u.comment,onChange:s=>j({...u,comment:s.target.value}),rows:3,style:{width:"100%",resize:"vertical"},required:!0})]}),e.jsx("button",{type:"submit",className:"primary",disabled:R,children:R?"Submitting...":"Submit Review"})]}):e.jsxs("div",{className:"empty",style:{padding:"1rem"},children:[e.jsx("p",{children:"Please log in or sign up to write a review."}),e.jsxs("div",{style:{marginTop:"0.75rem",display:"flex",gap:"0.5rem",justifyContent:"center"},children:[e.jsx("button",{className:"primary",onClick:()=>l(`/login?returnTo=/products/${t}#reviews&mode=login`),children:"Login"}),e.jsx("button",{onClick:()=>l(`/login?returnTo=/products/${t}#reviews&mode=register`),children:"Register"})]})]})]})]})]}),a&&e.jsxs("details",{className:"api-debug",children:[e.jsx("summary",{children:"API Response"}),e.jsx("pre",{children:JSON.stringify({product:a,reviews:d},null,2)})]})]})}export{ae as default};
